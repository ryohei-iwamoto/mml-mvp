# MML-MVP: 機械モデリング言語（卒業研究MVP）

## 0. コンセプト

機械設計では、最終成果物として「寸法が確定した図面/CAD」が作られる。
しかし設計の初期段階では、実際に重要なのは以下である。

- どんな動き・機能を実現したいのか（意図）
- そのためにどんな機構を選ぶのか（構造）
- どんな制約を満たす必要があるのか（加工・規格・強度・組立）
- 材料や製法が変わっても成立する抽象性（柔軟性）

図面に落とし込むと寸法が固定されるため、材料や製法の変更に追従しづらい。
そこで本研究では、ラフスケッチと対話入力から「設計意図」を抽象言語として保持し、
その抽象モデルから図面を生成できるパイプラインを作る。

本MVPはその第一段階として、板金ブラケット/プレート系に対象を限定し、
以下を一気通貫で実現する：

**ラフ画像 → 認識 → 対話で曖昧さ解消 → 中間言語(MML-JSON) → 図面(DXF)出力**

---

## 1. 本MVPにおける「機械モデリング言語」とは

このMVPにおける「機械モデリング言語」は、CADのように形状操作を列挙する言語ではない。
設計の意図を、次のレイヤで統合表現するための中間言語である。

- Feature: 何を作るか（例: plate, bracket）
- Interface: 何と繋ぐか（例: bolt pattern, hole standard）
- Constraint: 何を満たすべきか（例: 板厚 >= 2mm, 曲げR >= t, 端距離 >= 2d）
- Provenance: どれが画像推定で、どれが対話で確定したか（追跡可能性）

MVPでは中間言語として **MML-JSON** を採用する。
将来的にテキストDSLへ拡張可能だが、まずは自動生成・検証しやすいJSONに固定する。

---

## 2. スコープ（MVPでやる / やらない）

### MVPでやる
- 白背景・黒線のラフ画像からの要素認識（外形/穴/曲げ線候補）
- 認識結果が曖昧な箇所を「対話」で確定（スケール、穴規格など）
- 中間言語(MML-JSON)の生成
- 図面(DXF)の生成（外形線・穴・曲げ線・注記）
- 推論レポート(report.json)出力（確信度、質問、回答、確定値）

### MVPでやらない
- 3D STEP生成
- 本格FEM/最適化（強度計算は将来拡張）
- 写真や複雑背景のラフ対応
- 完全自動で寸法が確定すること（必ず1つ以上ユーザー回答でスケール確定）

---

## 3. 全体パイプライン

1) `vision`: 画像から外形・穴・曲げ線候補を抽出し、`vision.json`へ
2) `interact`: `vision.json`を元に、スケールや穴規格などの不足情報を質問して確定
3) `emit`: 確定した内容を `mml.json` (MML-JSON) と `report.json` として出力
4) `draw`: `mml.json` から図面 `drawing.dxf` を生成

---

## 4. CLI

- `mml vision input.png -o out/`
  - 出力: `out/vision.json`

- `mml interact input.png --chat=rule -o out/`
  - 出力: `out/mml.json`, `out/report.json`

- `mml draw out/mml.json -o out/`
  - 出力: `out/drawing.dxf`

- `mml pipeline input.png --chat=rule -o out/`
  - 出力: `out/vision.json`, `out/mml.json`, `out/report.json`, `out/drawing.dxf`

---

## 5. MML-JSON（中間言語）スキーマ（MVP最小構成）

```json
{
  "part": "Bracket",
  "units": "mm",
  "scale": { "px_to_mm": 0.5 },
  "material": { "name": "A5052" },
  "process": { "name": "sheet_metal" },
  "geometry": {
    "outline": { "type": "polygon", "points_mm": [[0,0],[100,0],[100,50],[0,50]] },
    "holes": [
      { "type": "clearance", "standard": "M5", "diameter_mm": 5.5, "center_mm": [50,25] }
    ],
    "bend": {
      "line_mm": [[60,0],[60,50]],
      "angle_deg": 90,
      "inner_radius_mm": 2.0
    }
  },
  "constraints": [
    { "kind": "min_thickness", "value_mm": 2.0 },
    { "kind": "bend_radius_gte_thickness" },
    { "kind": "edge_distance_gte", "multiplier": 2.0 }
  ],
  "provenance": {
    "vision": { "file": "input.png", "version": "0.1" },
    "chat": { "mode": "rule", "questions": [], "answers": [] }
  }
}
```

## 6. 完了条件

- 画像→認識→対話→中間言語→DXF出力が一気通貫で動く
- mml.json に provenance（vision/chat）が含まれる
- DXFがレイヤ分けされ、外形と穴が円で出力される
- 自動テストで3ケースが再現可能（画像はテスト内で生成）

---

## 7. 画像認識モジュール仕様

### 7.1 前提条件（MVP制約）
- 入力画像: 白背景・黒線の線画
- 1画像につき1部品
- 対象: プレート / 板金ブラケット
- パース歪みなし
- 塗りつぶし領域なし（線画のみ）

### 7.2 前処理
1. グレースケール変換
2. 二値化（大津の閾値）
3. モルフォロジー演算（オープニング/クロージング）でノイズ除去
4. エッジ検出（Canny）

### 7.3 特徴抽出

#### 外形検出
- 全輪郭を抽出
- 最大面積の輪郭を外形として選択
- 近似多角形（Douglas-Peucker法）
- ピクセル座標で順序付き多角形として保存

#### 穴検出
- ハフ円変換 または
- 高い真円度を持つ閉じた輪郭を検出
- 中心(cx, cy)、半径(r)、確信度を保存

#### 曲げ線検出
- 確率的ハフ直線検出を使用
- 外形内部の長い直線をフィルタリング
- 線分の端点と確信度を保存

### 7.4 画像認識出力フォーマット (`vision.json`)
```json
{
  "outline": { "type": "polygon", "points_px": [[...]] },
  "holes": [
    { "center_px": [120, 80], "radius_px": 9, "confidence": 0.82 }
  ],
  "bend_lines": [
    { "line_px": [[60, 10], [60, 180]], "confidence": 0.63 }
  ],
  "notes_regions": [
    { "bbox_px": [x,y,w,h], "confidence": 0.55 }
  ]
}
```

## 8. 対話/チャットモジュール仕様

### 8.1 目的

画像認識だけでは判断できない曖昧さを解消する。

典型的な曖昧さ:
- ピクセル-mm間のスケール
- 穴規格（M4 / M5 / M6 ...）
- 板厚
- 曲げ角度と内側R

### 8.2 必須質問

スケールを定義する質問が最低1つ回答されなければならない。

例:
- 「外形プレートの実際の幅(mm)は？」
- 「この穴はどのボルト規格に対応しますか？」

### 8.3 ルールベースチャット（MVPデフォルト）

MVPでは、決定論的なルールベースの質問生成器で十分とする。

ロジック例:
- `scale.px_to_mm` が未定義 → 基準寸法を1つ質問
- 穴の半径にばらつきがある → 統一するか質問
- 曲げが検出され角度未定義 → 曲げ角度を質問（デフォルト提案: 90度）

### 8.4 チャット状態表現
```json
{
  "questions": [
    { "id": "scale_ref", "text": "プレートの幅(mm)は？" }
  ],
  "answers": [
    { "id": "scale_ref", "value": 100 }
  ]
}
```

## 9. 中間言語出力（MML-JSON）

### 9.1 責務
- ピクセルベースのジオメトリを実寸法単位に変換
- 規格の正規化（例: ボルト → ばか穴径）
- 出所の記録（画像認識 vs ユーザー判断）

### 9.2 設計原則

MML-JSONは以下を満たす:
- 決定論的であること
- 明示的であること（暗黙のデフォルト値なし）
- 追跡可能であること（各値がなぜ選ばれたか）

## 10. 図面生成（DXF）

### 10.1 使用ライブラリ
ezdxf

### 10.2 レイヤ構成
- OUTLINE: 外形線（正面図/上面図/右側面図）
- HOLES: 穴の円（上面図）
- BEND: 曲げ線（一点鎖線）
- CENTER: 穴・フィーチャの中心線
- HIDDEN: 投影図の隠れ線
- TEXT: 注記

### 10.2.1 ビュー配置
第三角法（正面図の上に上面図、正面図の右に右側面図）

### 10.3 注記ルール

常に含める:
- 部品名
- 材料
- 板厚
- 穴規格のサマリ

MVPでは寸法矢印なし、シンプルなテキスト注記のみ。

例:
```
PART: Bracket
MAT: A5052  t=2.0
HOLES: 4x M5 clearance
BEND: 90deg R=2.0
```

## 11. CLIの動作詳細

### mml vision
- 入力: 画像ファイル
- 出力: vision.json
- ユーザー操作なし

### mml interact
- 入力: 画像 または vision.json
- 出力: mml.json, report.json
- 必須質問への回答が必要

### mml draw
- 入力: mml.json
- 出力: drawing.dxf

### mml pipeline
- vision → interact → draw を順に実行

## 12. テスト戦略

### 12.1 テスト方針
- 全テストが再現可能であること
- 外部画像アセットを使用しない
- テスト画像はプログラムで生成する

### 12.2 テスト画像生成

OpenCVで合成線画を生成:
- 矩形 → 外形
- 円 → 穴
- 直線 → 曲げ線

## 13. テストケース

### テストケース1: 4穴付きシンプルプレート

目的: エンドツーエンドパイプラインの検証

手順:
1. 矩形（200x100 px）を生成
2. 等間隔の4つの円を生成
3. スケールとボルト規格を回答

期待結果:
- mml.json が生成される
- drawing.dxf に外形と4つの穴が含まれる

### テストケース2: 曲げ線付きプレート

目的: 曲げ認識と対話の検証

手順:
1. 矩形 + 内部の直線
2. 曲げ角度と板厚を回答

期待結果:
- mml.json に曲げ情報が存在する
- DXFにBENDレイヤが存在する

### テストケース3: 曖昧な穴サイズ

目的: 対話による曖昧さ解消の検証

手順:
1. 半径の異なる2つの穴
2. ユーザーが統一規格を選択

期待結果:
- 全穴が同一径に正規化される
- report.json に正規化の判断が記録される

## 14. 卒業研究における位置づけ

本MVPが示すもの:
- 画像ベースの解釈とシンボリックモデリングの統合
- 機械モデリング言語の具体的な実現
- 抽象的な設計意図から製造成果物への再現可能なパイプライン

本システムはCADの代替ではなく、**CAD前段階の設計意図コンパイラ**である。

## 15. 今後の展望（MVPスコープ外）

- テキストベースのDSLフロントエンド
- 3Dジオメトリ（STEP）
- FEM連携
- マルチパートアセンブリ
- 学習ベースの画像認識モデル
- LLMによる設計提案
